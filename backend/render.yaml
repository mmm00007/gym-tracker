services:
  - type: web
    name: gym-tracker-api
    runtime: python
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: ALLOWED_ORIGINS
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: CRON_SHARED_SECRET
        sync: false
      - key: SET_CENTRIC_LOGGING
        value: "true"
      - key: LIBRARY_SCREEN_ENABLED
        value: "true"
      - key: ANALYSIS_ON_DEMAND_ONLY
        value: "true"

cronJobs:
  - name: gym-tracker-weekly-trends
    runtime: docker
    schedule: "0 6 * * 1"
    dockerCommand: |
      /bin/sh -lc 'curl --fail -sS -X POST "$API_BASE_URL/api/jobs/generate-weekly-trends" \
      -H "Content-Type: application/json" \
      -H "x-cron-secret: $CRON_SHARED_SECRET" \
      -d "{\"user_id\":\"$TREND_USER_ID\"}"'
    envVars:
      - key: API_BASE_URL
        sync: false
      - key: CRON_SHARED_SECRET
        sync: false
      - key: TREND_USER_ID
        sync: false
